@model EvaFashion.Web.Models.SanPham
@{
    ViewData["Title"] = Model.TenSanPham;
    var colors = ViewBag.Colors as List<EvaFashion.Web.Models.MauSac>;
    var sizes = ViewBag.Sizes as List<EvaFashion.Web.Models.KichCo>;
    var relatedProducts = ViewBag.RelatedProducts as List<EvaFashion.Web.Models.SanPham>;
    
    // Review Stats
    var averageRating = Model.DanhGias != null && Model.DanhGias.Any() ? Model.DanhGias.Average(d => d.SoSao) : 0;
    var reviewCount = Model.DanhGias != null ? Model.DanhGias.Count : 0;
    var fullStars = (int)(averageRating ?? 0);
    var hasHalfStar = (averageRating - fullStars) >= 0.5;
}

<div class="container py-5">
    <div class="row">
        <!-- Product Images -->
        <div class="col-md-6 mb-4">
            @if (Model.AnhSanPhams != null && Model.AnhSanPhams.Any())
            {
                <div id="productCarousel" class="carousel slide border rounded shadow-sm" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <!-- Main Image as first slide -->
                        <div class="carousel-item active">
                            <img src="@(string.IsNullOrEmpty(Model.HinhAnhChinh) ? "https://placehold.co/500x600" : Model.HinhAnhChinh)" 
                                 class="d-block w-100" style="object-fit: cover; max-height: 600px;" alt="@Model.TenSanPham">
                        </div>
                        <!-- Additional Images -->
                        @foreach (var img in Model.AnhSanPhams)
                        {
                            <div class="carousel-item">
                                <img src="@img.Url" class="d-block w-100" style="object-fit: cover; max-height: 600px;" alt="Ảnh chi tiết">
                            </div>
                        }
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                        <span class="bg-white rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 40px; height: 40px;">
                            <i class="bi bi-chevron-left text-dark fs-5"></i>
                        </span>
                        <span class="visually-hidden">Trước</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                        <span class="bg-white rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 40px; height: 40px;">
                            <i class="bi bi-chevron-right text-dark fs-5"></i>
                        </span>
                        <span class="visually-hidden">Sau</span>
                    </button>
                </div>
            }
            else
            {
                <div class="main-image mb-3 p-1 border rounded shadow-sm">
                    <img id="mainImage" src="@(string.IsNullOrEmpty(Model.HinhAnhChinh) ? "https://placehold.co/500x600" : Model.HinhAnhChinh)" 
                         class="img-fluid w-100" style="object-fit: cover; max-height: 600px;" alt="@Model.TenSanPham">
                </div>
            }
            <!-- Thumbnails (Simplified for now) -->
        </div>

        <!-- Product Details -->
        <div class="col-md-6">
            <h1 class="fw-bold fs-2">@Model.TenSanPham</h1>
            <div class="d-flex align-items-center mb-3">
                <div class="text-warning small me-2">
                    @for (int i = 1; i <= 5; i++)
                    {
                        if (i <= fullStars) { <i class="bi bi-star-fill"></i> }
                        else if (i == fullStars + 1 && hasHalfStar) { <i class="bi bi-star-half"></i> }
                        else { <i class="bi bi-star"></i> }
                    }
                </div>
                <small class="text-muted">(@reviewCount đánh giá)</small>
            </div>

            <div class="mb-4">
                @if (Model.PhanTramGiam > 0)
                {
                     <span class="fs-3 fw-bold text-danger me-2">@Model.GiaSauGiam?.ToString("N0") đ</span>
                     <span class="text-decoration-line-through text-muted fs-5">@Model.GiaGoc.ToString("N0") đ</span>
                     <span class="badge bg-danger ms-2">Giảm @Model.PhanTramGiam%</span>
                }
                else
                {
                    <span class="fs-3 fw-bold text-dark">@Model.GiaGoc.ToString("N0") đ</span>
                }
            </div>

            <p class="text-muted mb-4">@Model.MoTaNgan</p>

            @using Microsoft.AspNetCore.Http
            @inject IHttpContextAccessor HttpContextAccessor
            @{
                var role = HttpContextAccessor.HttpContext.Session.GetString("Role");
            }

            @if (role != "admin")
            {
            <form id="addToCartForm" asp-controller="Cart" asp-action="AddToCart" method="post" novalidate>
                <input type="hidden" name="productId" value="@Model.Id" />
                
                <!-- Color Selection -->
                @if (colors != null && colors.Any())
                {
                    <div class="mb-3">
                        <label class="fw-bold mb-2">Màu sắc:</label>
                        <div class="d-flex gap-2">
                            @foreach (var c in colors)
                            {
                                <input type="radio" class="btn-check" name="colorId" id="color-@c.MaMau" value="@c.MaMau" required>
                                <label class="btn btn-outline-secondary rounded-circle p-1 d-flex align-items-center justify-content-center" 
                                       for="color-@c.MaMau" style="width: 40px; height: 40px;" title="@c.TenMau">
                                    <span style="width: 25px; height: 25px; background-color: @c.MaHex; border: 1px solid #ddd; border-radius: 50%;"></span>
                                </label>
                            }
                        </div>
                    </div>
                }

                <!-- Size Selection -->
                 @if (sizes != null && sizes.Any())
                {
                    <div class="mb-4">
                        <label class="fw-bold mb-2">Kích cỡ:</label>
                        <div class="d-flex gap-2">
                            @foreach (var s in sizes)
                            {
                                <input type="radio" class="btn-check" name="sizeId" id="size-@s.MaKichCo" value="@s.MaKichCo" required>
                                <label class="btn btn-outline-secondary" for="size-@s.MaKichCo" style="min-width: 50px;">
                                    @s.TenKichCo
                                </label>
                            }
                        </div>
                    </div>
                }

                <div class="row align-items-end mb-4">
                   <div class="col-auto">
                        <label class="fw-bold mb-2">Số lượng:</label>
                        <input type="number" name="quantity" class="form-control text-center" value="1" min="1" max="100" style="width: 80px;">
                   </div>
                   <div class="col">
                        <button type="submit" class="btn btn-dark w-100 py-2 rounded-0 shadow-sm mb-2" name="buyNow" value="false">
                            <i class="bi bi-cart-plus me-2"></i> THÊM VÀO GIỎ
                        </button>
                        <button type="submit" class="btn btn-danger w-100 py-2 rounded-0 shadow-sm" name="buyNow" value="true">
                            <i class="bi bi-lightning-charge me-2"></i> MUA NGAY
                        </button>
                   </div>
                </div>
            </form>
            }
            else
            {
                <div class="alert alert-warning">
                    <i class="bi bi-shield-lock-fill me-2"></i> Admin không thể mua hàng.
                </div>
            }

            <div class="accordion" id="prodAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#desc">
                            Mô tả chi tiết
                        </button>
                    </h2>
                    <div id="desc" class="accordion-collapse collapse show" data-bs-parent="#prodAccordion">
                        <div class="accordion-body">
                            @Model.MoTaChiTiet
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                     <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#policy">
                            Chính sách đổi trả
                        </button>
                    </h2>
                     <div id="policy" class="accordion-collapse collapse" data-bs-parent="#prodAccordion">
                        <div class="accordion-body text-muted small">
                            Đổi trả miễn phí trong vòng 7 ngày nếu lỗi do nhà sản xuất.
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                     <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#reviews">
                            Đánh giá (@reviewCount)
                        </button>
                    </h2>
                     <div id="reviews" class="accordion-collapse collapse" data-bs-parent="#prodAccordion">
                        <div class="accordion-body">
                             @if (Model.DanhGias != null && Model.DanhGias.Any())
                            {
                                foreach (var review in Model.DanhGias.OrderByDescending(r => r.NgayDanhGia))
                                {
                                    <div class="mb-3 border-bottom pb-2">
                                        <div class="d-flex justify-content-between">
                                            <span class="fw-bold">@(review.NguoiDung?.HoTen ?? "Khách")</span>
                                            <small class="text-muted">@review.NgayDanhGia?.ToString("dd/MM/yyyy")</small>
                                        </div>
                                        <div class="text-warning small mb-1">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                if (i <= review.SoSao) { <i class="bi bi-star-fill"></i> }
                                                else { <i class="bi bi-star"></i> }
                                            }
                                        </div>
                                        <p class="mb-0 text-muted">@review.NoiDung</p>
                                    </div>
                                }
                            }
                            else
                            {
                                <p class="text-muted">Chưa có đánh giá nào.</p>
                            }

                             @{
                                // Reuse HttpContextAccessor injected earlier if available, or just use Context
                                var isLoggedIn = Context.Session.GetInt32("UserId").HasValue;
                            }

                            @if (isLoggedIn)
                            {
                                <form asp-controller="Shop" asp-action="AddReview" method="post" class="mt-4">
                                    <input type="hidden" name="productId" value="@Model.Id" />
                                    <h5 class="fw-bold mb-3">Viết đánh giá của bạn</h5>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Đánh giá:</label>
                                        <select name="rating" class="form-select w-auto">
                                            <option value="5">5 sao - Tuyệt vời</option>
                                            <option value="4">4 sao - Rất tốt</option>
                                            <option value="3">3 sao - Bình thường</option>
                                            <option value="2">2 sao - Tệ</option>
                                            <option value="1">1 sao - Rất tệ</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Nội dung:</label>
                                        <textarea name="content" class="form-control" rows="3" required placeholder="Chia sẻ cảm nhận của bạn..."></textarea>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-dark">Gửi đánh giá</button>
                                </form>
                            }
                            else
                            {
                                <div class="mt-3">
                                    <a href="/Account/Login" class="btn btn-outline-dark btn-sm">Đăng nhập để đánh giá</a>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Products -->
    @if (relatedProducts != null && relatedProducts.Any())
    {
        <div class="mt-5 pt-3 border-top">
            <h3 class="fw-bold mb-4 text-center">Có thể bạn sẽ thích</h3>
             <div class="row row-cols-2 row-cols-md-4 g-4">
                @foreach (var item in relatedProducts)
                {
                     <div class="col">
                         <div class="card h-100 border-0 shadow-sm">
                             <a href="/Shop/Detail/@item.Id">
                                 <img src="@(string.IsNullOrEmpty(item.HinhAnhChinh) ? "https://placehold.co/300x400" : item.HinhAnhChinh)" class="card-img-top" alt="@item.TenSanPham">
                             </a>
                             <div class="card-body text-center p-2">
                                 <div class="fw-bold">
                                     <a href="/Shop/Detail/@item.Id" class="text-decoration-none text-dark">@item.TenSanPham</a>
                                 </div>
                                 <div class="text-danger fw-bold small">@item.GiaGoc.ToString("N0") đ</div>
                             </div>
                         </div>
                     </div>
                }
             </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var form = document.getElementById('addToCartForm');
            if (form) {
                console.log("Form found, attaching validator");
                form.addEventListener('submit', function(e) {
                    var colorChecked = form.querySelector('input[name="colorId"]:checked');
                    var sizeChecked = form.querySelector('input[name="sizeId"]:checked');
                    
                    if (!colorChecked || !sizeChecked) {
                        e.preventDefault();
                        alert('Vui lòng chọn Màu sắc và Kích cỡ trước khi mua hàng!');
                        console.log("Validation failed: Color or Size missing");
                    }
                });
            } else {
                console.error("AddToCart form not found");
            }
        });
    </script>
}
